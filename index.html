<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moje aktivní objednávky</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Animace načítání */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        
        <div class="flex flex-col gap-4 mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Moje aktivní objednávky:</h1>
            
            <div>
                <button onclick="window.location.href='https://nts-windows-tools.github.io/NTS-65f6bgh5gfh5gj6hzh98gv4-55-shopNTS/'" class="flex items-center gap-2 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                    </svg>
                    Zpět
                </button>
            </div>
        </div>

        <hr class="border-t-2 border-gray-300 mb-8">

        <div id="orders-container" class="space-y-6">
            <div class="loader"></div>
            <p class="text-center text-gray-500">Načítám vaše objednávky...</p>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <button onclick="window.location.href='https://nts-windows-tools.github.io/NTS-65f6bgh5gfh5gj6hzh98gv4-55-shopNTS/'" class="flex items-center gap-2 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                </svg>
                Zpět
            </button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Konfigurace Firebase (shodná s ostatními soubory)
        const firebaseConfig = {
            apiKey: "AIzaSyDWuTL_dbpAaLc6GEaIBwyQMCemYrrT1DM",
            authDomain: "nts-eshop.firebaseapp.com",
            projectId: "nts-eshop",
            databaseURL: "https://nts-eshop-default-rtdb.europe-west1.firebasedatabase.app",
            storageBucket: "nts-eshop.firebasestorage.app",
            messagingSenderId: "882610702624",
            appId: "1:882610702624:web:d692d9421d493119ebaf45",
            measurementId: "G-C2G6CMEBJ5"
        };

        // Inicializace
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const productsRef = ref(db, 'products');

        const ordersContainer = document.getElementById('orders-container');

        // Funkce pro vykreslení karty objednávky
        function createOrderCard(key, product) {
            const card = document.createElement('div');
            card.className = "bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden";
            
            // Mapování typu
            const typText = product.Typ === 'Nove' ? 'NOVÁ PRODEJKA' : (product.Typ === 'Bazar' ? 'BAZAR' : 'Neurčeno');
            
            // Logika pro PIN
            // Pokud PIN existuje a není prázdný -> Zobrazit PIN
            // Pokud je prázdný -> Zobrazit "Přijato..."
            const pinValue = product.PIN_vyzvednuti;
            const hasPin = pinValue && String(pinValue).trim().length > 0;

            let blueStripContent = '';
            if (hasPin) {
                blueStripContent = `
                    <div class="flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 flex-shrink-0">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        <div>
                            <p class="font-bold text-lg">Přijďte si pro objednávku!</p>
                            <p class="font-mono text-xl">PIN pro vyzvednutí: <span class="bg-white px-2 rounded text-blue-800 border border-blue-200">${pinValue}</span></p>
                        </div>
                    </div>
                `;
            } else {
                blueStripContent = `
                    <div class="flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 flex-shrink-0 animate-pulse">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        <p class="font-medium">Přijato, zpracováváme. Sledujte aktualizace v e-mailu.</p>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">${product.PRODUCT}</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 mb-6">
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Stav</p>
                            <p class="font-bold text-gray-900">${typText}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Objednáno kusů</p>
                            <p class="font-bold text-gray-900">${product.Objednano || 'N/A'}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Typ platby</p>
                            <p class="font-bold text-gray-900">${product.Objednavka_Platba || 'N/A'}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs text-gray-500 uppercase font-semibold">Slevový kód</p>
                            <p class="font-bold text-gray-900">${product.Objednavka_Sleva || 'Žádný'}</p>
                        </div>
                    </div>

                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-900 p-4 rounded-r-lg">
                        ${blueStripContent}
                    </div>
                </div>
            `;
            return card;
        }

        // Listener na změny v databázi
        onValue(productsRef, (snapshot) => {
            ordersContainer.innerHTML = ''; // Vyčistit kontejner
            const data = snapshot.val();
            let hasOrders = false;

            if (data) {
                // Iterace přes produkty
                Object.entries(data).forEach(([key, product]) => {
                    // Filtrujeme pouze aktivní objednávky (Reservation == 1)
                    if (product.Reservation && parseInt(product.Reservation, 10) === 1) {
                        hasOrders = true;

                        // DŮLEŽITÉ: Kontrola existence sloupce PIN_vyzvednuti
                        // Pokud neexistuje (je undefined), vytvoříme ho v DB jako prázdný řetězec
                        // Používáme update, což může vyvolat znovu onValue, ale jelikož tam bude prázdný string,
                        // podruhé už podmínka neprojde -> bezpečné.
                        if (product.PIN_vyzvednuti === undefined) {
                            console.log(`Vytvářím prázdný PIN slot pro produkt: ${key}`);
                            update(ref(db, `products/${key}`), {
                                PIN_vyzvednuti: ""
                            });
                            // Poznámka: Změna v DB vyvolá refresh této funkce, takže se UI překreslí samo.
                        }

                        // Vykreslení karty
                        const card = createOrderCard(key, product);
                        ordersContainer.appendChild(card);
                    }
                });
            }

            if (!hasOrders) {
                ordersContainer.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-lg shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-gray-300 mb-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                        </svg>
                        <p class="text-xl text-gray-500 font-semibold">Nemáte žádné aktivní objednávky.</p>
                        <p class="text-gray-400 mt-2">Objednávky, které byly již vyřízeny nebo stornovány, se zde nezobrazují.</p>
                    </div>
                `;
            }
        }, (error) => {
            console.error("Chyba databáze:", error);
            ordersContainer.innerHTML = `<p class="text-red-500 text-center font-bold">Nepodařilo se načíst objednávky. Zkuste to prosím později.</p>`;
        });

    </script>
</body>
</html>